# FastAPI Backend Dockerfile
# ë³´ì•ˆ ê°•í™”: Non-root user ì‹¤í–‰

FROM python:3.11-slim

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ë° í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    gcc \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Python ì˜ì¡´ì„± ë³µì‚¬ ë° ì„¤ì¹˜
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY ./app /app/app

# ğŸ”’ ë³´ì•ˆ: Non-root ì‚¬ìš©ì ìƒì„± ë° ì „í™˜
# - ì»¨í…Œì´ë„ˆê°€ íƒˆì·¨ë˜ì–´ë„ root ê¶Œí•œ ì—†ìŒ
# - í˜¸ìŠ¤íŠ¸ ì‹œìŠ¤í…œ í”¼í•´ ìµœì†Œí™”
# - Kubernetes ë“±ì—ì„œ ë³´ì•ˆ ì •ì±… ì¤€ìˆ˜
RUN adduser --disabled-password --gecos "" --uid 1000 caffeine-user \
    && chown -R caffeine-user:caffeine-user /app

# caffeine-userë¡œ ì „í™˜
USER caffeine-user

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8000

# í—¬ìŠ¤ ì²´í¬
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import requests; requests.get('http://localhost:8000/health')"

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
